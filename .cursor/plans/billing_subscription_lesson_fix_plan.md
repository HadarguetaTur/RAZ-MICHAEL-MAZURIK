# תוכנית: תיקון חיוב שיעור כשיש מנוי פעיל (מאיה)

## הבעיה

- **מאיה** יש לה מנוי פעיל (מנוי זוגי ₪520, מתאריך 30.9.2025 עד 27.11.2067).
- למרות זאת, שיעור **זוגי** אחד (2.2.2026) הופיע בחיוב בסכום ₪112.5.
- **הכלל הרצוי:** כשיש מנוי פעיל שמכסה את התאריך — שיעור **זוגי** או **קבוצתי** לא אמור להיחייב (סכום 0). המנוי כבר מחויב בנפרד (₪520).

בנוסף: בסיכום מופיע "סה"כ לתשלום: ₪2.5" בעוד שסכום השיעורים + מנויים = ₪632.5 — זה באג נפרד (מקור ה־2.5: כנראה שדה אחר / lookup / התאמה ידנית).

---

## איפה הלוגיקה היום

- **קובץ:** [billing/billingRules.ts](billing/billingRules.ts)
- **פונקציה:** `calculateLessonAmount(lesson, subscriptions)`

**סדר הבדיקות הנוכחי:**

1. אם ל־`lesson` יש **line_amount** (לא undefined ולא null) → מחזירים אותו **מיד**, **בלי** לבדוק מנוי.
2. רק אם אין line_amount — בודקים סוג שיעור (זוגי/קבוצתי) ורק אז בודקים `checkActiveSubscriptionForLesson`; אם יש מנוי פעיל → 0.

**לכן:** אם בשיעור הזוגי של מאיה יש **line_amount = 112.5** (מנוסחה או שדה ב-Airtable), הקוד מחזיר 112.5 ולא בודק מנוי. התוצאה: שיעור זוגי עם מנוי נספר בחיוב.

---

## מה לשנות (רק תכנון — בלי לבצע)

### שינוי 1: ב־`calculateLessonAmount` — לבדוק מנוי **לפני** line_amount בשיעור זוגי/קבוצתי

**קובץ:** `billing/billingRules.ts`  
**פונקציה:** `calculateLessonAmount`

**לוגיקה חדשה מוצעת:**

1. **שיעור זוגי או קבוצתי:**  
   - אם הועברו `subscriptions` ויש ל־lesson `start_datetime`:  
     - להריץ `checkActiveSubscriptionForLesson(studentId, lessonDate, subscriptions)`.  
   - אם יש מנוי פעיל → **להחזיר 0** (לא לחייב על השיעור), **בלי** להתחשב ב־`line_amount`.  
   - רק אם **אין** מנוי פעיל — להמשיך לחישוב הסכום (line_amount אם קיים, אחרת ברירת מחדל 112.5 / 120).

2. **שיעור פרטי:**  
   - להשאיר כמו היום: אם יש `line_amount` להחזיר אותו; אחרת 175.  
   - (אין כלל "מנוי מכסה שיעור פרטי" בקוד הנוכחי.)

**בפועל:** להזיז את בדיקת המנוי (והחזרת 0) ל-**תחילת** הענף של זוגי/קבוצתי, **לפני** השורה שבודקת `lesson.line_amount`. כלומר: בשיעור זוגי/קבוצתי — קודם מנוי (אם פעיל → 0), ורק אחר כך line_amount או מחיר ברירת מחדל.

**לא משנים:**

- את `checkActiveSubscriptionForLesson` (תאריכים, student_id, pause).
- את `calculateLessonsContribution` (איך אוספים שיעורים ומנויים).
- את מנוע החיובים ב־billingEngine (איך מושכים מנויים ומוסרים ל־calculateLessonsContribution).

---

### שינוי 2 (אופציונלי): וידוא ששדה המנוי בטבלת מנויים תואם

- המנוע מקבץ מנויים לפי `sub.fields.student_id`.  
- אם בטבלת המנויים ב-Airtable השדה נקרא אחרת (למשל "תלמידים"), אז `student_id` יכול להיות ריק ולא יוצמדו מנויים לתלמיד — ואז בדיקת המנוי תמיד תחזיר "אין מנוי".  
- **לבדוק** שבטבלת המנויים שדה הקישור לתלמיד באמת נקרא `student_id` (או לעדכן את הקוד לקרוא גם משדה חלופי אם קיים).

---

### לא בתוכנית הזו

- **סה"כ לתשלום ₪2.5** — מקור הסכום (טבלת חיובים / lookup / התאמה) וסיבת אי-ההתאמה ל־632.5 יטופלו בנפרד (לפי התוכנית "סכומים רק מטבלת חיובים" והתאמת total_amount).

---

## סיכום השינויים המתוכננים

| מקום | שינוי מתוכנן |
|------|---------------|
| `billingRules.ts` → `calculateLessonAmount` | בשיעור **זוגי** ו**קבוצתי**: לבדוק מנוי פעיל **קודם**; אם יש → להחזיר 0. רק אם אין מנוי — להשתמש ב־line_amount או במחיר ברירת מחדל. |
| (אופציונלי) | לוודא ששדה הקישור לתלמיד בטבלת מנויים נקרא `student_id` או לעדכן מיפוי. |

אחרי השינוי, הרצת "יצירת חיובים" (או עדכון חיוב) עבור מאיה תחשב עבור השיעור הזוגי 0 ולא 112.5, כך ש־lessons_amount לא יכלול את השיעור הזה כשיש מנוי פעיל.
