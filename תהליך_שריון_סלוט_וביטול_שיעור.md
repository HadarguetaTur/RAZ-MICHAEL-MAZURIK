# תהליך שריון סלוט וביטול שיעור - מיפוי מלא

## תהליך שריון סלוט (reserveSlotAndCreateLessons)

### שלב 1: טעינת slot_inventory
**מיקום:** `services/slotBookingService.ts:100-105`
```typescript
const slotRecord = await airtableClient.getRecord<SlotInventoryAirtableFields>(
  slotTableId,
  slotId
);
```

### שלב 2: חילוץ שדות
**מיקום:** `services/slotBookingService.ts:110-123`
- תאריך שיעור (`תאריך_שיעור`)
- שעת התחלה (`שעת_התחלה`)
- שעת סיום (`שעת_סיום`)
- מורה (`מורה`)
- סוג שיעור (`סוג_שיעור`)

### שלב 3: יצירת שיעורים
**מיקום:** `services/slotBookingService.ts:213-227`
```typescript
for (const studentRecordId of studentIds) {
  const lesson = await nexusApi.createLesson({
    studentId: studentRecordId,
    date,
    startTime,
    duration: durationMin,
    teacherId: finalTeacherRecordId,
    status: LessonStatus.SCHEDULED,
    source: 'slot_inventory', // ✅ מסומן כבא מ-slot_inventory
    lessonType: lessonType,
  });
  createdLessons.push(lesson);
}
```

### שלב 4: עדכון slot_inventory
**מיקום:** `services/slotBookingService.ts:235-290`

**מה מתעדכן:**
1. **סטטוס** → `'סגור'` (שורה 236)
2. **lessons field** → מעדכן עם רשימת ID-ים של השיעורים שנוצרו (שורה 254-264)
3. **תלמידים field** → מעדכן עם רשימת ID-ים של התלמידים (שורה 267-277)

```typescript
const updateFields: Partial<SlotInventoryAirtableFields> = {
  'סטטוס': 'סגור', // Status = closed
};

// Link lessons
const lessonsField = getField('slotInventory', 'lessons');
if (lessonsField) {
  const lessonIds = createdLessons.map(l => l.id);
  (updateFields as any)[lessonsField] = lessonIds;
}

// Link students
const studentsField = getField('slotInventory', 'תלמידים');
if (studentsField) {
  (updateFields as any)[studentsField] = studentIds;
}

// Update in Airtable
await airtableClient.updateRecord(slotTableId, slotId, updateFields, { typecast: true });
```

### שלב 5: ביטול קאש
**מיקום:** `services/slotBookingService.ts:362-386`
```typescript
invalidateLessons();
invalidateSlotInventory();
```

---

## תהליך ביטול שיעור והחזרת סלוט לפתוח

### שלב 1: ביטול שיעור
**מיקום:** `components/Calendar.tsx:840` או `881`
```typescript
const updated = await updateLesson(cancelModalLesson.id, { 
  status: LessonStatus.CANCELLED // = 'בוטל'
});
```

### שלב 2: זיהוי ביטול ב-mutations
**מיקום:** `data/mutations.ts:63`
```typescript
// ✅ תוקן: בודק גם 'בוטל' (עברית)
if (updates.status === 'CANCELLED' || updates.status === 'cancelled' || updates.status === 'בוטל') {
  const reopenedSlots = await reopenSlotsForCancelledLesson(id);
}
```

### שלב 3: חיפוש slot_inventory מקושר
**מיקום:** `services/slotReopeningService.ts:26-34`

**פילטר Airtable:**
```typescript
const filterFormula = `{lessons} = '${lessonId}'`;
// זה מחפש כל slot_inventory שיש לו את השיעור הזה ב-lessons field
```

### שלב 4: עיבוד כל slot שנמצא
**מיקום:** `services/slotReopeningService.ts:45-103`

**לוגיקה:**
1. מחלץ את רשימת השיעורים המקושרים
2. מסיר את השיעור המבוטל מהרשימה
3. אם אין עוד שיעורים → מחזיר לסטטוס `'פתוח'`
4. אם יש עוד שיעורים → משאיר סגור אבל מעדכן את הרשימה

```typescript
// Extract lesson IDs
let lessonIds: string[] = [];
if (Array.isArray(linkedLessons)) {
  lessonIds = linkedLessons.map((l: any) => typeof l === 'string' ? l : l.id).filter(Boolean);
}

// Remove cancelled lesson
const remainingLessons = lessonIds.filter(id => id !== lessonId);

// If no lessons remain, reopen the slot
if (remainingLessons.length === 0) {
  updateFields['סטטוס'] = 'פתוח';
  reopenedSlotIds.push(slot.id);
} else {
  // Still has other lessons, keep closed but update list
  updateFields[lessonsField] = remainingLessons;
}
```

### שלב 5: עדכון slot_inventory
**מיקום:** `services/slotReopeningService.ts:84-90`
```typescript
await airtableClient.updateRecord<SlotInventoryAirtableFields>(
  slotTableId,
  slot.id,
  updateFields,
  { typecast: true }
);
```

### שלב 6: ביטול קאש ו-refresh
**מיקום:** `services/slotReopeningService.ts:106-107` + `components/Calendar.tsx:862`
```typescript
invalidateSlotInventory();
await refreshData(true); // ב-Calendar אחרי ביטול
```

---

## פילטר shouldRenderOpenSlot - למה סלוט לא מופיע?

**מיקום:** `components/Calendar.tsx:33-92`

הפונקציה מסננת סלוטים פתוחים לפי 3 תנאים:

### Guard 1: סטטוס חייב להיות 'open'
```typescript
if (slot.status !== 'open') {
  return false; // לא מופיע
}
```

### Guard 2: אין שיעורים מקושרים
```typescript
if (slot.lessons && slot.lessons.length > 0) {
  return false; // לא מופיע - יש שיעורים מקושרים
}
```

### Guard 3: אין שיעור תואם (תאריך, שעה, מורה)
```typescript
const hasMatchingLesson = allLessons.some(lesson => {
  const dateMatches = lesson.date === slot.date;
  const timeMatches = lesson.startTime === slot.startTime;
  const teacherMatches = lesson.teacherId === slot.teacherId;
  return dateMatches && timeMatches && teacherMatches;
});

if (hasMatchingLesson) {
  return false; // לא מופיע - יש שיעור תואם
}
```

---

## בעיות אפשריות

### בעיה #1: הפילטר לא מוצא slots
**סיבה:** הפילטר `{lessons} = 'lessonId'` לא עובד נכון
**פתרון:** לבדוק ב-console אם הפילטר מוצא slots

### בעיה #2: עדכון לא עובד
**סיבה:** השדה `lessons` לא מתעדכן נכון
**פתרון:** לבדוק ב-Airtable אם השדה מתעדכן

### בעיה #3: shouldRenderOpenSlot מסנן
**סיבה:** 
- סטטוס לא 'open' (עדיין 'סגור')
- יש שיעורים מקושרים (הרשימה לא התעדכנה)
- יש שיעור תואם (השיעור המבוטל עדיין מופיע ב-lessons)

**פתרון:** לבדוק את כל התנאים

### בעיה #4: קאש לא מתעדכן
**סיבה:** `refreshData()` נקרא לפני שהעדכון מסתיים
**פתרון:** להשתמש ב-`refreshData(true)` עם forceRefresh

---

## לוגים לניפוי באגים

הוספתי לוגים מפורטים ב:
- `services/slotReopeningService.ts` - כל שלב בתהליך
- `data/mutations.ts` - כשמזהה ביטול שיעור

**מה לבדוק ב-console:**
1. `[reopenSlotsForCancelledLesson] Starting` - האם הפונקציה רצה?
2. `[reopenSlotsForCancelledLesson] Found X slot(s)` - כמה slots נמצאו?
3. `[reopenSlotsForCancelledLesson] Reopening slot` - האם מחזיר לפתוח?
4. `[Mutations] updateLesson | Reopened X slot(s)` - כמה slots נפתחו?

---

## תיקון שנעשה

✅ **תוקן:** התנאי ב-`mutations.ts` עכשיו בודק גם `'בוטל'` (עברית) ולא רק `'CANCELLED'`

✅ **נוסף:** לוגים מפורטים בכל שלב בתהליך

✅ **שופר:** `refreshData(true)` נקרא אחרי ביטול שיעור
