# תוכנית ביצוע - ייצוב Slot Inventory

## סטטוס נוכחי
✅ **כל השינויים כבר מיושמים בקוד**

## שלב 1: בדיקת Duplicates (חשוב ביותר)

### 1.1 בדיקת Fetch Layer
**מקום**: `services/nexusApi.ts:getSlotInventory()`

**מה לבדוק**:
1. פתח את הקונסול בדפדפן (F12)
2. עבור ל-Availability → טאב "חריגים וחד-פעמי"
3. בדוק בקונסול:
   - `[getSlotInventory] Raw fetch: X records, Y unique IDs`
   - אם `X !== Y` → יש duplicates ב-API (לא אמור לקרות)
   - `[getSlotInventory] Mapped inventory: X items, Y unique IDs`
   - אם `X !== Y` → יש duplicates אחרי mapping (לא אמור לקרות)

**תוצאה צפויה**:
- מספר הרשומות = מספר ה-IDs הייחודיים
- אין אזהרות על duplicates

### 1.2 בדיקת State Layer
**מקום**: `components/Availability.tsx:loadInventory()`

**מה לבדוק**:
1. בקונסול, חפש:
   - `[Availability] loadInventory: X slots, Y unique IDs`
2. אם יש duplicates, תראה:
   - `[Availability] DUPLICATE SLOTS IN INVENTORY ARRAY`

**תוצאה צפויה**:
- אין duplicates במערך state

### 1.3 בדיקת UI Rendering
**מקום**: `components/WeeklySlotsGrid.tsx`

**מה לבדוק**:
1. בדוק שהכלים מוצגים פעם אחת בלבד
2. פתח DevTools → Elements
3. חפש `key={inventorySlot.id}` - כל key צריך להיות ייחודי

**תוצאה צפויה**:
- כל slot מוצג פעם אחת בלבד
- אין duplicates ויזואליים

### 1.4 בדיקת Edge Cases
**מה לבדוק**:
1. **שינוי שבוע**: לחץ על ← או → לשבוע אחר
   - בדוק שאין duplicates אחרי שינוי שבוע
2. **מחיקה**: מחק slot
   - בדוק שהסלוט נמחק ולא מופיע שוב
3. **חסימה**: חסום slot
   - בדוק שהסלוט לא מופיע כפול
4. **עריכה**: ערוך slot
   - בדוק שהסלוט לא מופיע כפול אחרי שמירה

**תוצאה צפויה**:
- אין duplicates אחרי כל פעולה

---

## שלב 2: בדיקת Shared Modal

### 2.1 בדיקה מ-Calendar
**מה לבדוק**:
1. עבור ל-Calendar
2. לחץ על open slot (חלון פתוח)
3. בדוק שהמודל נפתח
4. בדוק שהמודל מציג את המידע הנכון
5. שמור/סגור את המודל

**תוצאה צפויה**:
- המודל נפתח מ-Calendar
- המידע נכון
- הפעולות עובדות

### 2.2 בדיקה מ-Slot Inventory
**מה לבדוק**:
1. עבור ל-Availability → טאב "חריגים וחד-פעמי"
2. לחץ על כפתור "שריין חלון" על slot פתוח
3. בדוק שהמודל נפתח (אותו מודל כמו ב-Calendar)
4. בדוק שהמידע נכון
5. שמור/סגור את המודל

**תוצאה צפויה**:
- אותו מודל כמו ב-Calendar
- המידע נכון
- הפעולות עובדות

### 2.3 בדיקת Consistency
**מה לבדוק**:
1. פתח modal מ-Calendar
2. סגור אותו
3. פתח modal מ-Slot Inventory
4. בדוק שהמצב נכון (לא נשאר מידע מהפעם הקודמת)

**תוצאה צפויה**:
- כל פתיחה של modal היא נקייה
- אין state שנותר מהפעם הקודמת

---

## שלב 3: בדיקת Actions (Edit/Delete/Block)

### 3.1 בדיקת Edit
**מה לבדוק**:
1. לחץ על "ערוך" על slot
2. בדוק שהטופס נפתח עם המידע הנכון
3. שנה משהו (זמן, תאריך, מורה)
4. שמור
5. בדוק שהשינויים נשמרו
6. בדוק שאין duplicates אחרי השמירה

**תוצאה צפויה**:
- הטופס נפתח עם מידע נכון
- השינויים נשמרים
- אין duplicates

### 3.2 בדיקת Delete
**מה לבדוק**:
1. לחץ על "מחק" על slot
2. אשר את המחיקה
3. בדוק שהסלוט נמחק
4. בדוק שהסלוט לא מופיע שוב (גם אחרי refresh)
5. בדוק שאין duplicates אחרי המחיקה

**תוצאה צפויה**:
- הסלוט נמחק
- לא מופיע שוב
- אין duplicates

### 3.3 בדיקת Block
**מה לבדוק**:
1. לחץ על "חסום" על slot פתוח
2. אשר את החסימה
3. בדוק שהסלוט משנה צבע/סטטוס ל"חסום"
4. בדוק ב-Airtable שהסטטוס הוא "חסום ע"י מנהל"
5. לחץ על "ביטול חסימה"
6. בדוק שהסלוט חוזר להיות פתוח
7. בדוק שאין duplicates אחרי החסימה/ביטול

**תוצאה צפויה**:
- החסימה עובדת
- הסטטוס ב-Airtable נכון
- ביטול חסימה עובד
- אין duplicates

---

## שלב 4: בדיקת Overlap Rules

### 4.1 בדיקת Internal Overlaps (Warning Only)
**מה לבדוק**:
1. צור slot חדש בתאריך שיש בו כבר slot פתוח באותו זמן
2. בדוק שמופיעה אזהרה צהובה (warning)
3. בדוק שאפשר לשמור למרות האזהרה
4. בדוק שהאזהרה מציגה את הסלוטים החופפים

**תוצאה צפויה**:
- אזהרה צהובה מופיעה
- אפשר לשמור למרות האזהרה
- רשימת סלוטים חופפים נכונה

### 4.2 בדיקת Lesson Overlaps (Blocking)
**מה לבדוק**:
1. צור slot חדש בתאריך שיש בו שיעור באותו זמן
2. בדוק שמופיעה שגיאה אדומה (blocking)
3. בדוק שאי אפשר לשמור (כפתור Save מושבת)
4. בדוק שהשגיאה מציגה את השיעורים החופפים

**תוצאה צפויה**:
- שגיאה אדומה מופיעה
- אי אפשר לשמור
- רשימת שיעורים חופפים נכונה

### 4.3 בדיקת Self-Exclusion
**מה לבדוק**:
1. ערוך slot קיים
2. שמור אותו ללא שינויים (אותו זמן, אותו תאריך)
3. בדוק שאין אזהרה/שגיאה (הסלוט לא משווה את עצמו)

**תוצאה צפויה**:
- אין אזהרה/שגיאה בעריכה ללא שינויים
- הסלוט נשמר בהצלחה

### 4.4 בדיקת Scope (Same Date Only)
**מה לבדוק**:
1. צור slot בתאריך X עם זמן מסוים
2. בדוק שסלוטים בתאריך Y (אפילו באותו זמן) לא נחשבים חופפים
3. בדוק ששיעורים בתאריך Y לא נחשבים חופפים

**תוצאה צפויה**:
- רק סלוטים/שיעורים באותו תאריך נבדקים
- סלוטים/שיעורים בתאריכים שונים לא נחשבים חופפים

---

## שלב 5: בדיקת Regressions

### 5.1 בדיקת Booking Flow
**מה לבדוק**:
1. עבור ל-Calendar
2. צור שיעור חדש
3. בדוק שהכל עובד כמו קודם
4. בדוק שאין שגיאות בקונסול

**תוצאה צפויה**:
- יצירת שיעור עובדת
- אין שגיאות

### 5.2 בדיקת Lessons Calendar
**מה לבדוק**:
1. עבור ל-Calendar
2. בדוק שהשיעורים מוצגים נכון
3. בדוק שאפשר לערוך שיעורים
4. בדוק שאפשר למחוק שיעורים

**תוצאה צפויה**:
- הכל עובד כמו קודם
- אין regressions

### 5.3 בדיקת Weekly Slots
**מה לבדוק**:
1. עבור ל-Availability → טאב "זמינות שבועי"
2. בדוק שהסלוטים השבועיים מוצגים נכון
3. בדוק שאפשר לערוך/למחוק סלוטים שבועיים
4. בדוק שאין duplicates

**תוצאה צפויה**:
- הכל עובד כמו קודם
- אין regressions

---

## שלב 6: בדיקת Status Mapping

### 6.1 בדיקת Block Status
**מה לבדוק**:
1. חסום slot
2. בדוק ב-Airtable שהסטטוס הוא "חסום ע"י מנהל"
3. רענן את הדף
4. בדוק שהסלוט מוצג כחסום (צבע/סטטוס)

**תוצאה צפויה**:
- הסטטוס ב-Airtable נכון
- אחרי רענון, הסלוט מוצג כחסום

### 6.2 בדיקת Status Values
**מה לבדוק**:
1. בדוק שכל הסטטוסים מופיעים נכון:
   - "פתוח" / "open" → פתוח
   - "סגור" / "closed" → סגור
   - "חסום ע"י מנהל" / "blocked" → חסום
   - "מבוטל" / "canceled" → מבוטל

**תוצאה צפויה**:
- כל הסטטוסים מופיעים נכון

---

## שלב 7: ניקוי DEV Logs (אופציונלי)

### 7.1 הסרת Logs
**מה לעשות**:
1. אם הכל עובד טוב, אפשר להסיר את ה-DEV logs
2. או להשאיר אותם לבדיקות עתידיות

**מיקומים**:
- `services/nexusApi.ts` - שורות 1269-1278, 1290-1297
- `components/Availability.tsx` - שורות 352-365

**החלטה**:
- אם יש duplicates → השאר את ה-logs לבדיקה
- אם אין duplicates → אפשר להסיר

---

## Checklist סופי

### לפני Deploy:
- [ ] אין duplicates בכל הבדיקות
- [ ] Shared modal עובד מ-Calendar ו-Slot Inventory
- [ ] Edit/Delete/Block עובדים נכון
- [ ] Overlap rules עובדים נכון (warning/blocking)
- [ ] Self-exclusion עובד
- [ ] Scope נכון (same date only)
- [ ] אין regressions ב-booking/lessons/weekly slots
- [ ] Status mapping נכון
- [ ] אין שגיאות בקונסול

### אחרי Deploy:
- [ ] בדיקה בסביבת Production
- [ ] בדיקה עם משתמשים אמיתיים
- [ ] ניטור שגיאות

---

## הערות חשובות

1. **Duplicates**: זה החלק הכי חשוב לבדוק. אם יש duplicates, הכל לא יעבוד נכון.

2. **Overlap Rules**: חשוב לבדוק שהכללים נכונים:
   - Internal overlaps = warning (לא חוסם)
   - Lesson overlaps = blocking (חוסם)
   - Self-exclusion עובד

3. **Status Mapping**: חשוב לבדוק ש"חסום ע"י מנהל" מופיע נכון בכל המקומות.

4. **Regressions**: חשוב לבדוק שלא שברנו דברים קיימים.

---

## סיכום

כל השינויים כבר מיושמים בקוד. עכשיו צריך:
1. לבדוק שהכל עובד
2. לוודא שאין duplicates
3. לוודא שהכללים נכונים
4. לוודא שאין regressions

אם הכל עובד טוב → מוכן ל-deploy!
אם יש בעיות → לתקן לפי התוכנית.
